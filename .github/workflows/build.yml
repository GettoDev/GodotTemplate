name: Build Godot Windows (Ubuntu 24.04)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest  # Ubuntu 24.04
    
    steps:
    - name: Checkout Godot source
      uses: actions/checkout@v3
      with:
        repository: godotengine/godot
        ref: '4.5.1-stable'
        submodules: 'recursive'
        
    - name: Install MinGW POSIX for Ubuntu 24.04
      run: |
        sudo apt-get update
        
        # En Ubuntu 24.04, los paquetes tienen nombres diferentes
        # Instalar TODAS las versiones y luego configurar POSIX
        
        echo "=== Instalando MinGW en Ubuntu 24.04 ==="
        sudo apt-get install -y \
          build-essential \
          scons \
          pkg-config \
          mingw-w64 \
          g++-mingw-w64 \
          gcc-mingw-w64 \
          binutils-mingw-w64
        
        echo "=== Listando archivos MinGW disponibles ==="
        ls -la /usr/bin/*mingw* 2>/dev/null || true
        
        echo "=== Configurando POSIX threads ==="
        # En Ubuntu 24.04, debemos usar los symlinks directamente
        sudo rm -f /usr/bin/x86_64-w64-mingw32-g++
        sudo rm -f /usr/bin/x86_64-w64-mingw32-gcc
        
        # Crear symlinks a las versiones POSIX
        sudo ln -sf /usr/bin/x86_64-w64-mingw32-g++-posix /usr/bin/x86_64-w64-mingw32-g++
        sudo ln -sf /usr/bin/x86_64-w64-mingw32-gcc-posix /usr/bin/x86_64-w64-mingw32-gcc
        
        echo "=== Verificando configuraciÃ³n ==="
        ls -la /usr/bin/x86_64-w64-mingw32-g*
        
        echo "=== Probando compilador ==="
        /usr/bin/x86_64-w64-mingw32-g++ --version || echo "Error testing compiler"
        
    - name: Install build dependencies
      run: |
        echo "=== Instalando dependencias de build ==="
        sudo apt-get install -y \
          python3 \
          libx11-dev \
          libxcursor-dev \
          libxi-dev \
          libxinerama-dev \
          libxrandr-dev \
          libasound2-dev \
          libpulse-dev \
          libudev-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev
        
    - name: Generate encryption key
      id: gen_key
      run: |
        echo "key=$(openssl rand -hex 32)" >> $GITHUB_OUTPUT
        echo "Encryption key generated"
        
    - name: Build Godot Windows Template
      run: |
        echo "=== INICIANDO BUILD DE GODOT ==="
        echo "Fecha: $(date)"
        echo "Ubuntu: $(lsb_release -d)"
        echo "MinGW: $(x86_64-w64-mingw32-g++ --version | head -1)"
        
        # Construir Godot
        echo "Compilando..."
        scons platform=windows \
          target=template_release \
          bits=64 \
          use_mingw=yes \
          builtin_brotli=yes \
          builtin_freetype=yes \
          verbose=yes \
          progress=yes \
          -j2
        
        echo "=== BUILD COMPLETADO ==="
        
        # Verificar archivo
        if [ -f "bin/godot.windows.template_release.x86_64.exe" ]; then
          cp bin/godot.windows.template_release.x86_64.exe godot_windows_template.exe
          echo "âœ… Template creado exitosamente"
          echo "ðŸ“ TamaÃ±o: $(stat -c%s godot_windows_template.exe) bytes"
        else
          echo "âŒ ERROR: No se encontrÃ³ el archivo compilado"
          echo "Contenido del directorio bin/:"
          ls -la bin/ 2>/dev/null || echo "Directorio bin/ no existe"
          exit 1
        fi
        
    - name: Create documentation
      run: |
        cat > INSTRUCCIONES.md << EOF
        # Godot Windows Template 4.5.1
        
        ## ðŸ”‘ Clave de EncriptaciÃ³n
        \`\`\`
        ${{ steps.gen_key.outputs.key }}
        \`\`\`
        
        **Â¡GUARDA ESTA CLAVE!** Es necesaria para:
        - Exportar juegos encriptados
        - Acceder a archivos .pck encriptados
        
        ## ðŸ“ InstalaciÃ³n
        
        1. Copia \`godot_windows_template.exe\` a:
           - **Windows**: \`%APPDATA%\\Godot\\export_templates\\4.5.1.stable\\\`
           - **Linux/Mac**: \`~/.local/share/godot/export_templates/4.5.1.stable/\`
        
        2. Renombra a: \`windows_64_release.exe\`
        
        3. En Godot Editor:
           - Editor â†’ Editor Settings â†’ Export â†’ Templates
           - Verifica que aparece 4.5.1
        
        ## ðŸ›¡ï¸ Uso de EncriptaciÃ³n
        
        1. Project â†’ Export
        2. Selecciona "Windows Desktop"
        3. En pestaÃ±a "Encryption":
           - Pega la clave de arriba
           - Marca "Encrypt PCK"
        4. Export Project
        
        ## ðŸ“Š InformaciÃ³n del Build
        - Godot: 4.5.1-stable
        - Fecha: $(date)
        - Sistema: Ubuntu 24.04
        - Con encriptaciÃ³n: SÃ­
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: godot-windows-4.5.1
        path: |
          godot_windows_template.exe
          INSTRUCCIONES.md
        retention-days: 90
