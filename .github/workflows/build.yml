name: Build Godot Windows Template

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Godot source
      uses: actions/checkout@v3
      with:
        repository: godotengine/godot
        ref: '4.5.1-stable'
        submodules: 'recursive'
        
    - name: Install MinGW for Ubuntu 24.04
      run: |
        sudo apt-get update
        # Instalar solo lo necesario para Ubuntu 24.04
        sudo apt-get install -y \
          build-essential \
          scons \
          pkg-config \
          mingw-w64 \
          g++-mingw-w64 \
          gcc-mingw-w64 \
          python3-pip
        
        # En Ubuntu 24.04, MinGW ya viene con POSIX por defecto
        # Solo necesitamos verificar y configurar
        echo "Verificando MinGW installation..."
        x86_64-w64-mingw32-g++ --version
        echo "MinGW instalado correctamente"
        
    - name: Install other build dependencies
      run: |
        sudo apt-get install -y \
          libx11-dev \
          libxcursor-dev \
          libxi-dev \
          libxinerama-dev \
          libxrandr-dev \
          libasound2-dev \
          libpulse-dev \
          libudev-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev
        
    - name: Generate encryption key
      id: gen_key
      run: |
        echo "key=$(openssl rand -hex 32)" >> $GITHUB_OUTPUT
        echo "Encryption key generated"
        
    - name: Build Windows 64-bit Template
      run: |
        echo "=== STARTING BUILD ==="
        echo "Platform: Windows"
        echo "Target: template_release"
        echo "Bits: 64"
        echo "Encryption: Enabled"
        echo "======================"
        
        # Construir Godot para Windows
        scons platform=windows \
          target=template_release \
          bits=64 \
          use_mingw=yes \
          builtin_brotli=yes \
          builtin_freetype=yes \
          verbose=yes \
          progress=yes \
          -j2
        
        echo "=== BUILD COMPLETED ==="
        
        # Copiar el resultado
        if [ -f "bin/godot.windows.template_release.x86_64.exe" ]; then
          cp bin/godot.windows.template_release.x86_64.exe windows_template_64.exe
          echo "Template saved as windows_template_64.exe"
          ls -lh windows_template_64.exe
        else
          echo "ERROR: Build file not found!"
          ls -la bin/
          exit 1
        fi
        
    - name: Create instruction file
      run: |
        # Crear archivo con instrucciones
        cat > INSTRUCTIONS.txt << 'EOF'
        ===========================================
        GODOT WINDOWS TEMPLATE 4.5.1
        ===========================================
        
        IMPORTANTE: GUARDA ESTA CLAVE DE ENCRIPTACIÓN
        
        Clave: ${{ steps.gen_key.outputs.key }}
        
        SIN ESTA CLAVE NO PODRÁS:
        - Exportar juegos encriptados
        - Abrir los archivos .pck encriptados
        
        ===========================================
        INSTALACIÓN:
        
        1. Copia "windows_template_64.exe" a:
        
           Windows:
           %APPDATA%\Godot\export_templates\4.5.1.stable\
        
           Linux/Mac:
           ~/.local/share/godot/export_templates/4.5.1.stable/
        
        2. Renombra el archivo a:
           windows_64_release.exe
        
        3. En Godot Editor:
           - Ve a Editor → Editor Settings → Export → Templates
           - Verifica que la versión 4.5.1 aparece
        
        ===========================================
        USO DE ENCRIPCIÓN:
        
        1. En Godot: Project → Export
        2. Selecciona "Windows Desktop"
        3. En la pestaña "Encryption":
           - Pega la clave de arriba
           - Marca "Encrypt PCK"
        4. Exporta tu juego
        
        ===========================================
        NOTAS:
        - Build date: $(date)
        - Godot version: 4.5.1-stable
        - Compiled with encryption support
        ===========================================
        EOF
        
        # Reemplazar la variable de la clave
        sed -i "s/\\\${{ steps.gen_key.outputs.key }}/${{ steps.gen_key.outputs.key }}/g" INSTRUCTIONS.txt
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: godot-windows-template-4.5.1
        path: |
          windows_template_64.exe
          INSTRUCTIONS.txt
        retention-days: 90
