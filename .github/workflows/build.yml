name: Build Godot Windows

on:
  workflow_dispatch:  # Solo se ejecuta manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Godot source
      uses: actions/checkout@v3
      with:
        repository: godotengine/godot
        ref: '4.5.1-stable'
        submodules: 'recursive'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          scons \
          pkg-config \
          mingw-w64 \
          python3-pip
        
    - name: Generate encryption key
      id: gen_key
      run: |
        echo "key=$(openssl rand -hex 32)" >> $GITHUB_OUTPUT
        echo "ENCRYPTION_KEY generated and saved to secret"
        
    - name: Build Windows 64-bit
      run: |
        # Export the encryption key
        export ENCRYPTION_KEY="${{ steps.gen_key.outputs.key }}"
        
        # Build the template
        scons platform=windows \
          target=template_release \
          bits=64 \
          use_mingw=yes \
          builtin_brotli=enabled \
          verbose=yes \
          -j2
          
    - name: Save the template
      run: |
        # Rename and prepare for download
        cp bin/godot.windows.template_release.x86_64.exe windows_template.exe
        echo "ENCRYPTION_KEY=${{ steps.gen_key.outputs.key }}" > encryption_key.txt
        echo "IMPORTANTE: Guarda esta clave para desencriptar tu juego" >> encryption_key.txt
        
    - name: Upload template
      uses: actions/upload-artifact@v4
      with:
        name: godot-windows-template
        path: |
          windows_template.exe
          encryption_key.txt
